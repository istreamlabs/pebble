version: '1.0'
steps:
  prep:
    title: Prepping...
    image: codefresh/cli
    environment:
    - BUCKET_NAME=pebble-dev
    # This is the ID of the github integration in codefresh
    - GITHUB_CONTEXT_NAME=github-oauth
    commands:
    - cf_export GITHUB_TOKEN=$(codefresh get context $GITHUB_CONTEXT_NAME --decrypt -o yaml | yq -y .spec.data.auth.password)
    - cf_export CI=true
    - cf_export NODE_IMAGE=node:10.15.3
    - cf_export STAGING_URL=http://$BUCKET_NAME.s3-website-us-west-2.amazonaws.com/$CF_PULL_REQUEST_NUMBER
    - cf_export S3_PATH=$BUCKET_NAME/$CF_PULL_REQUEST_NUMBER
    - env | grep CF_
  pr_staging_pending:
    title: PR status deploying...
    image: cloudposse/github-status-updater
    environment:
    - GITHUB_ACTION=update_state
    - GITHUB_OWNER=${{CF_REPO_OWNER}}
    - GITHUB_REPO=${{CF_REPO_NAME}}
    - GITHUB_REF=${{CF_REVISION}}
    - GITHUB_CONTEXT=Test Deployment
    - GITHUB_STATE=pending
    - GITHUB_DESCRIPTION=Deploying
    - GITHUB_TARGET_URL=${{STAGING_URL}}/index.html
  install_dependencies:
    title: Installing Dependecies...
    image: ${{NODE_IMAGE}}
    commands:
    - yarn
  build:
    image: ${{NODE_IMAGE}}
    title: Building...
    environment:
    - PUBLIC_URL=/${{CF_PULL_REQUEST_NUMBER}}/
    commands:
    - yarn styleguide:build
  deploy:
    title: Deploying...
    image: codefresh/s3copy
    environment:
    - AWS_ACCESS_KEY_ID=${{DEVELOPMENT_AWS_ACCESS_KEY}}
    - AWS_SECRET_ACCESS_KEY=${{DEVELOPMENT_AWS_SECRET}}
    commands:
    - ./deploy.sh "$S3_PATH"
  pr_staging_complete:
    title: PR status complete...
    image: cloudposse/github-status-updater
    environment:
    - GITHUB_ACTION=update_state
    - GITHUB_OWNER=${{CF_REPO_OWNER}}
    - GITHUB_REPO=${{CF_REPO_NAME}}
    - GITHUB_REF=${{CF_REVISION}}
    - GITHUB_CONTEXT=Test Deployment
    - GITHUB_STATE=success
    - GITHUB_DESCRIPTION=Completed
    - GITHUB_TARGET_URL=${{STAGING_URL}}/index.html
